let currentData=null,selectedRowIndex=null,columnInfo=[],db,currentTableName=null;function displayTableStructure(e,t){let l=e.exec(`PRAGMA table_info(${t});`),a=document.getElementById("output");if(a.innerHTML="",l.length>0){let n=`<h3>Table Structure: ${t}</h3><table><thead><tr><th>Column Name</th><th>Data Type</th><th>Not Null</th><th>Default</th><th>Primary Key</th></tr></thead><tbody>`;l[0].values.forEach(e=>{n+="<tr>",n+=`<td>${e[1]}</td>`,n+=`<td>${e[2]}</td>`,n+=`<td>${1===e[3]?"Yes":"No"}</td>`,n+=`<td>${null===e[4]?"":e[4]}</td>`,n+=`<td>${1===e[5]?"Yes":"No"}</td>`,n+="</tr>"}),n+="</tbody></table>",a.innerHTML=n}else a.innerHTML="No structure found."}function displayTableData(e,t){currentTableName=t,document.getElementById("sqliteDownloadSqlButton").disabled=!1;let l=e.exec("SELECT * FROM "+t),a=document.getElementById("output");a.innerHTML="",columnInfo=e.exec(`PRAGMA table_info(${t});`)[0].values,l.length>0?(a.innerHTML=`<h3>Table Content: ${t}</h3>`+createTable(l[0]),currentData=l[0]):a.innerHTML=`<h3>Table Content: ${t}</h3><p>No data found.</p>`}function createTable(e){let t='<table class="sqlite-table-data"><thead><tr>';return e.columns.forEach(e=>{t+=`<th>${e}</th>`}),t+="</tr></thead><tbody>",e.values.forEach((e,l)=>{t+="<tr>",e.forEach((e,l)=>{t+=`<td>${null!==e?e:""}</td>`}),t+="</tr>"}),t+="</tbody></table>"}function displayEditForm(e){let t=document.getElementById("editForm");t.innerHTML="",currentData.columns.forEach((l,a)=>{let n=""+getDataType(l);currentData.values[0][a]?.toString().length;let r=document.createElement("div");r.classList.add("data-column"),r.innerHTML=`<div>${l} <div class="data-type">${n}</div></div>`;let d;"text"===n.toLocaleLowerCase()||"longtext"===n.toLocaleLowerCase()?((d=document.createElement("textarea")).value=e[a]||"",d.setAttribute("spellcheck","false")):((d=document.createElement("input")).type="text",d.value=e[a]||""),r.appendChild(d),t.appendChild(r)})}function getDataType(e){let t=columnInfo.find(t=>t[1]===e);return t?t[2]:"UNKNOWN"}function hilightTable(e){let t=e.target.closest("li"),l=t.closest("ul").querySelectorAll("li");l.forEach(e=>{e.classList.remove("highlight")}),t.classList.add("highlight")}document.getElementById("sqliteFileInput").addEventListener("change",function(e){let t=e.target.files[0];if(!t)return;let l=new FileReader;l.onload=function(e){let t=e.target.result,l=new Uint8Array(t);initSqlJs({locateFile:e=>"js/sql-wasm.wasm"}).then(e=>{let t=(db=new e.Database(l)).exec("SELECT name FROM sqlite_master WHERE type='table';"),a=document.querySelector("#sqlite-table-sidebar #sqlite-table-list");a.innerHTML="",t[0].values.forEach(e=>{let t=document.createElement("li"),l=e[0],n=document.createElement("a");n.href="#",n.innerText=l,n.classList.add("sqlite-table-content"),n.addEventListener("click",function(e){e.preventDefault(),displayTableData(db,l),hilightTable(e)});let r=document.createElement("a");r.href="#",r.innerText="#",r.classList.add("sqlite-table-structure"),r.addEventListener("click",function(e){e.preventDefault(),displayTableStructure(db,l),hilightTable(e)}),t.appendChild(r),t.appendChild(document.createTextNode(" ")),t.appendChild(n),a.appendChild(t)}),document.getElementById("sqliteDownloadAllSqlButton").disabled=!1})},l.readAsArrayBuffer(t)}),document.addEventListener("click",function(e){if("TD"===e.target.tagName&&e.target.closest("table").classList.contains("sqlite-table-data")){let t=e.target.parentNode.rowIndex-1;if(null!==selectedRowIndex){let l=document.querySelectorAll("#output tr")[selectedRowIndex+1];l.classList.remove("selected")}selectedRowIndex=t,e.target.parentNode.classList.add("selected"),displayEditForm(currentData.values[t])}}),document.getElementById("sqliteDownloadAllSqlButton").addEventListener("click",function(){if(!db){alert("No database loaded!");return}let e=db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%';");if(0===e.length||0===e[0].values.length){alert("No tables found in the database.");return}let t=e[0].values.map(e=>e[0]),l="-- SQL Export for All Tables\n\n";t.forEach(e=>{let t=db.exec(`PRAGMA table_info(${e});`),a={};if(t.length>0){let n=t[0].values.map(e=>{let t=e[1],l=e[2];a[t]=l.toUpperCase();let n=1===e[3]?"NOT NULL":"",r=e[4]?`DEFAULT ${e[4]}`:"",d=1===e[5]?"PRIMARY KEY":"";return`${t} ${l} ${n} ${r} ${d}`.trim()}).join(",\n  ");l+=`-- Table: ${e}
`,l+=`CREATE TABLE ${e} (
  ${n}
);

`}let r=db.exec(`SELECT * FROM ${e};`);if(r.length>0){let d=r[0].columns,i=r[0].values;i.forEach(t=>{let n=t.map((e,t)=>{if(null===e)return"NULL";let l=d[t],n=a[l]||"";return/(INT|REAL|NUM|DECIMAL|DOUBLE|FLOAT)/.test(n)?e:`'${e.toString().replace(/'/g,"''")}'`});l+=`INSERT INTO ${e} (${d.join(", ")}) VALUES (${n.join(", ")});
`}),l+="\n"}});let a=new Blob([l],{type:"text/sql"}),n=URL.createObjectURL(a),r=document.createElement("a");r.href=n,r.download="all-tables.sql",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n)}),document.getElementById("sqliteDownloadSqlButton").addEventListener("click",function(){if(!db){alert("No database loaded!");return}let e=db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%';");if(0===e.length||0===e[0].values.length){alert("No tables found in the database.");return}let t="-- SQL Export for All Tables\n\n",l=currentTableName;if(!l){alert("No table selected!");return}let a=db.exec(`PRAGMA table_info(${l});`),n={};if(a.length>0){let r=a[0].values.map(e=>{let t=e[1],l=e[2];n[t]=l.toUpperCase();let a=1===e[3]?"NOT NULL":"",r=e[4]?`DEFAULT ${e[4]}`:"",d=1===e[5]?"PRIMARY KEY":"";return`${t} ${l} ${a} ${r} ${d}`.trim()}).join(",\n  ");t+=`-- Table: ${l}
`,t+=`CREATE TABLE ${l} (
  ${r}
);

`}let d=db.exec(`SELECT * FROM ${l};`);if(d.length>0){let i=d[0].columns,s=d[0].values;s.forEach(e=>{let a=e.map((e,t)=>{if(null===e)return"NULL";let l=i[t],a=n[l]||"";return/(INT|REAL|NUM|DECIMAL|DOUBLE|FLOAT)/.test(a)?e:`'${e.toString().replace(/'/g,"''")}'`});t+=`INSERT INTO ${l} (${i.join(", ")}) VALUES (${a.join(", ")});
`}),t+="\n"}let o=new Blob([t],{type:"text/sql"}),c=URL.createObjectURL(o),u=document.createElement("a");u.href=c,u.download=`${l}.sql`,document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(c)}),document.getElementById("sqliteLoadFromServerButton").addEventListener("click",function(){let e=document.getElementById("sqliteDatabaseUrl").value.trim();if(!e){alert("Please enter a valid URL to load the database.");return}fetch(e).then(e=>{if(!e.ok)throw Error("Failed to load database. Please check the URL.");return e.arrayBuffer()}).then(e=>{let t=new Uint8Array(e);initSqlJs({locateFile:e=>"js/sql-wasm.wasm"}).then(e=>{let l=(db=new e.Database(t)).exec("SELECT name FROM sqlite_master WHERE type='table';"),a=document.querySelector("#sqlite-table-sidebar #sqlite-table-list");a.innerHTML="",l[0].values.forEach(e=>{let t=document.createElement("li"),l=e[0],n=document.createElement("a");n.href="#",n.innerText=l,n.classList.add("sqlite-table-content"),n.addEventListener("click",function(e){e.preventDefault(),displayTableData(db,l),hilightTable(e)});let r=document.createElement("a");r.href="#",r.innerText="#",r.classList.add("sqlite-table-structure"),r.addEventListener("click",function(e){e.preventDefault(),displayTableStructure(db,l),hilightTable(e)}),t.appendChild(r),t.appendChild(document.createTextNode(" ")),t.appendChild(n),a.appendChild(t)}),document.getElementById("sqliteDownloadAllSqlButton").disabled=!1})}).catch(e=>{alert(`Error loading database from server: ${e.message}`)})});const modal=document.getElementById("privacyModal"),btn=document.getElementById("privacyButton"),span=document.getElementsByClassName("close")[0];btn&&btn.addEventListener("click",function(){modal.style.display="block"}),span&&span.addEventListener("click",function(){modal.style.display="none"}),window.addEventListener("click",function(e){e.target==modal&&(modal.style.display="none")});